<!-- VALIDATING STATE -->
@if (viewState() === 'validating') {
  <div class="min-h-screen bg-gray-900 bg-opacity-70 backdrop-blur-md flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-8 text-center">
      <div class="w-16 h-16 border-4 border-teal-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
      <h2 class="text-xl font-semibold text-gray-900 mb-2">Validating your tracking link...</h2>
      <p class="text-gray-600">Please wait a moment</p>
    </div>
  </div>
}

<!-- ERROR STATE -->
@if (viewState() === 'error') {
  <div class="min-h-screen bg-gray-900 bg-opacity-70 backdrop-blur-md flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-8">
      <div class="text-center">
        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <ng-icon name="heroExclamationCircle" class="w-8 h-8 text-red-600"></ng-icon>
        </div>
        <h2 class="text-2xl font-bold text-gray-900 mb-2">⚠️ Invalid or Expired Link</h2>
        <p class="text-gray-600 mb-6">{{ error() }}</p>
        <div class="space-y-3">
          <button 
            (click)="retryValidation()"
            class="w-full px-6 py-3 bg-teal-500 hover:bg-teal-600 text-white rounded-lg font-medium transition-colors">
            Try Again
          </button>
          <button 
            (click)="goToHome()"
            class="w-full px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-colors">
            Go to Home
          </button>
        </div>
      </div>
    </div>
  </div>
}

<!-- LOGIN PROMPT STATE (for registered users) -->
@if (viewState() === 'login-prompt') {
  <div class="min-h-screen bg-gray-900 bg-opacity-70 backdrop-blur-md flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-8">
      <div class="text-center">
        <div class="w-16 h-16 bg-teal-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-teal-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
        </div>
        <h2 class="text-2xl font-bold text-gray-900 mb-2">Welcome Back!</h2>
        <p class="text-gray-600 mb-6">We see you have an account with us. Please log in to track your ride with full features.</p>
        
        <div class="space-y-3">
          <button 
            (click)="redirectToLogin()"
            class="w-full px-6 py-3 bg-teal-500 hover:bg-teal-600 text-white rounded-lg font-medium transition-colors">
            Log In
          </button>
          <button 
            (click)="continueToTracking()"
            class="w-full px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-colors">
            Continue as Guest
          </button>
        </div>
      </div>
    </div>
  </div>
}

<!-- TRACKING STATE (main ride tracking view) -->
@if (viewState() === 'tracking') {
  <div class="flex flex-col lg:flex-row w-full h-screen bg-gray-100">
    <!-- Tracking Panel -->
    <div class="w-full lg:w-1/4 bg-white shadow-lg p-6 overflow-y-auto z-10 lg:h-full flex flex-col">
      <!-- Header -->
      <div class="flex items-center gap-3 mb-6">
        <div class="w-10 h-10 bg-teal-500 rounded-full flex items-center justify-center">
          <ng-icon name="heroMapPin" class="w-5 h-5 text-white"></ng-icon>
        </div>
        <h2 class="text-xl font-semibold text-gray-900 m-0">Track Your Ride</h2>
      </div>

      @if (loading()) {
        <div class="flex items-center justify-center py-12">
          <div class="text-center">
            <div class="w-12 h-12 border-4 border-teal-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-gray-600">Loading ride details...</p>
          </div>
        </div>
      }

      @if (!loading()) {
        <!-- Ride Completion Banner -->
        @if (rideCompleted()) {
          <div class="bg-gradient-to-br from-{{ getStatusColor() }}-50 to-{{ getStatusColor() }}-100 rounded-lg p-4 mb-6 border-2 border-{{ getStatusColor() }}-300">
            <div class="flex items-center gap-3 mb-3">
              <div class="w-12 h-12 bg-{{ getStatusColor() }}-500 rounded-full flex items-center justify-center">
                @if (rideStatus() === 'FINISHED') {
                  <ng-icon name="heroCheckCircle" class="w-6 h-6 text-white"></ng-icon>
                } @else {
                  <ng-icon name="heroXCircle" class="w-6 h-6 text-white"></ng-icon>
                }
              </div>
              <div class="flex-1">
                <p class="text-sm font-bold text-{{ getStatusColor() }}-900 m-0">{{ getStatusMessage() }}</p>
                <p class="text-xs text-{{ getStatusColor() }}-700 m-0 mt-1">This ride has ended</p>
              </div>
            </div>
            
            @if (rideStatus() === 'FINISHED' && finalPrice() > 0) {
              <div class="bg-white rounded-lg p-3 mt-3">
                <div class="flex items-center justify-between">
                  <span class="text-xs text-gray-600">Total Fare</span>
                  <span class="text-lg font-bold text-gray-900">{{ finalPrice() }} RSD</span>
                </div>
              </div>
            }
          </div>
        } @else {
          <!-- Live Ride Status -->
          <div class="bg-gradient-to-br from-teal-50 to-teal-100 rounded-lg p-4 mb-6">
            <div class="flex items-center gap-3 mb-3">
              <div class="w-12 h-12 bg-teal-500 rounded-full flex items-center justify-center">
                <ng-icon name="heroClock" class="w-6 h-6 text-white"></ng-icon>
              </div>
              <div class="flex-1">
                <p class="text-xs text-teal-700 m-0 mb-1">Estimated Arrival</p>
                <p class="text-2xl font-bold text-teal-900 m-0">{{ estimatedArrival() }} min</p>
              </div>
            </div>
            <div class="flex items-center gap-2 text-xs text-teal-700">
              <ng-icon name="heroMapPin" class="w-4 h-4"></ng-icon>
              <span>{{ remainingDistance() }} km remaining</span>
            </div>
          </div>
        }

        <!-- Ride Details -->
        <div class="bg-gray-50 rounded-lg p-4 mb-6">
          <h3 class="text-sm font-semibold text-gray-900 mb-3 m-0">Ride Details</h3>

          <div class="space-y-3">
            <div class="flex items-start gap-3">
              <ng-icon name="heroMapPin" class="w-4 h-4 text-teal-600 mt-1"></ng-icon>
              <div class="flex-1">
                <p class="text-xs text-gray-500 m-0 mb-1">Pickup</p>
                <p class="text-sm text-gray-900 m-0">{{ rideDetails().pickup }}</p>
              </div>
            </div>

            <div class="flex items-start gap-3">
              <ng-icon name="heroMapPin" class="w-4 h-4 text-red-600 mt-1"></ng-icon>
              <div class="flex-1">
                <p class="text-xs text-gray-500 m-0 mb-1">Destination</p>
                <p class="text-sm text-gray-900 m-0">{{ rideDetails().destination }}</p>
              </div>
            </div>

            <div class="flex items-center justify-between pt-2 border-t border-gray-200">
              <span class="text-xs text-gray-500">Driver</span>
              <span class="text-sm font-medium text-gray-900">{{ rideDetails().driverName }}</span>
            </div>

            <div class="flex items-center justify-between">
              <span class="text-xs text-gray-500">Vehicle</span>
              <span class="text-sm font-medium text-gray-900">{{ rideDetails().vehicleType }}</span>
            </div>

            <div class="flex items-center justify-between">
              <span class="text-xs text-gray-500">License Plate</span>
              <span class="text-sm font-medium text-gray-900">{{ rideDetails().licensePlate }}</span>
            </div>

            <div class="flex items-center justify-between">
              <span class="text-xs text-gray-500">Distance</span>
              <span class="text-sm font-medium text-gray-900">{{ rideDetails().totalDistance }} km</span>
            </div>
          </div>
        </div>

        <!-- Spacer -->
        <div class="flex-1"></div>

        <!-- Guest Info Banner -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
          <div class="flex items-start gap-3">
            <ng-icon name="heroInformationCircle" class="w-5 h-5 text-blue-600 mt-0.5"></ng-icon>
            <div>
              <h3 class="text-sm font-semibold text-blue-900 m-0 mb-1">Guest Tracking</h3>
              <p class="text-xs text-blue-700 m-0">
                @if (rideCompleted()) {
                  This ride has ended. Create an account to access your full ride history!
                } @else {
                  You're tracking this ride as a guest. Create an account for full features!
                }
              </p>
            </div>
          </div>
        </div>
      }
    </div>

    <!-- Map Container -->
    <div class="w-full lg:w-3/4 h-[50vh] lg:h-full relative">
      <div id="trackingMap" class="w-full h-full"></div>

      @if (!loading() && !rideCompleted()) {
        <!-- Live Updates Indicator -->
        <div class="absolute top-6 left-6 bg-white rounded-lg shadow-lg px-4 py-3 z-[1000] flex items-center gap-3">
          <div class="relative">
            <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
            <div class="absolute inset-0 w-3 h-3 bg-green-500 rounded-full animate-ping"></div>
          </div>
          <div>
            <p class="text-xs font-semibold text-gray-900 m-0">Live Tracking</p>
            <p class="text-xs text-gray-600 m-0">Updates every 5 seconds</p>
          </div>
        </div>

        <!-- Trip Progress -->
        <div class="absolute top-6 right-6 bg-white rounded-lg shadow-lg p-4 z-[1000]">
          <h3 class="text-sm font-semibold text-gray-900 mb-2 m-0">Trip Progress</h3>
          <div class="space-y-2">
            <div class="flex items-center gap-2">
              <ng-icon name="heroMapPin" class="w-4 h-4 text-gray-600"></ng-icon>
              <span class="text-xs text-gray-700">{{ rideDetails().totalDistance }} km total</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
              <div
                class="bg-teal-500 h-2 rounded-full transition-all duration-500"
                [style.width.%]="progressPercentage()">
              </div>
            </div>
            <p class="text-xs text-center text-gray-700 m-0">{{ progressPercentage() }}% complete</p>
          </div>
        </div>
      }

      @if (!loading() && rideCompleted()) {
        <!-- Completed Ride Overlay -->
        <div class="absolute top-6 left-1/2 transform -translate-x-1/2 bg-white rounded-lg shadow-lg px-6 py-4 z-[1000]">
          <div class="text-center">
            <p class="text-sm font-bold text-gray-900 m-0">{{ getStatusMessage() }}</p>
            <p class="text-xs text-gray-600 m-0 mt-1">Ride route shown below</p>
          </div>
        </div>
      }
    </div>
  </div>

  <!-- Ride Completion Dialog - WITH BLURRED DARK BACKDROP -->
  @if (showCompletionDialog()) {
    <div class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-md z-[9999] flex items-center justify-center p-4 animate-fadeIn">
      <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden animate-slideUp">
        <!-- Dialog Header -->
        <div class="bg-gradient-to-br from-{{ getStatusColor() }}-500 to-{{ getStatusColor() }}-600 p-6 text-white text-center">
          <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-4">
            @if (rideStatus() === 'FINISHED') {
              <ng-icon name="heroCheckCircle" class="w-10 h-10 text-{{ getStatusColor() }}-500"></ng-icon>
            } @else {
              <ng-icon name="heroXCircle" class="w-10 h-10 text-{{ getStatusColor() }}-500"></ng-icon>
            }
          </div>
          <h2 class="text-2xl font-bold m-0">{{ getStatusMessage() }}</h2>
        </div>

        <!-- Dialog Content -->
        <div class="p-6">
          @if (rideStatus() === 'FINISHED') {
            <div class="text-center mb-6">
              <p class="text-gray-700 mb-4">Thank you for riding with us!</p>
              
              @if (finalPrice() > 0) {
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                  <p class="text-sm text-gray-600 mb-1">Total Fare</p>
                  <p class="text-3xl font-bold text-gray-900">{{ finalPrice() }} RSD</p>
                </div>
              }

              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <p class="text-sm text-blue-800">
                  <strong>Want to save your ride history?</strong><br>
                  Create an account to track all your rides and get exclusive benefits!
                </p>
              </div>
            </div>
          } @else {
            <div class="text-center mb-6">
              <p class="text-gray-700">This ride has been cancelled.</p>
              <p class="text-sm text-gray-500 mt-2">If you have any questions, please contact support.</p>
            </div>
          }

          <!-- Action Buttons -->
          <div class="space-y-3">
            <button 
              (click)="closeCompletionDialog()"
              class="w-full px-6 py-3 bg-{{ getStatusColor() }}-500 hover:bg-{{ getStatusColor() }}-600 text-white rounded-lg font-medium transition-colors">
              View Ride Details
            </button>
            <button 
              (click)="goToHome()"
              class="w-full px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-colors">
              Go to Home
            </button>
          </div>
        </div>
      </div>
    </div>
  }
}

<style>
  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes slideUp {
    from {
      transform: translateY(20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }
  .vehicle-marker-smooth {
  transition: all 4.5s linear !important;
}

.leaflet-marker-icon.vehicle-marker-smooth {
  transition: all 4.5s linear !important;
}

.leaflet-marker-pane .vehicle-marker-smooth {
  transition: transform 4.5s linear !important;
}

  @keyframes vehiclePulse {
  0%, 100% {
    box-shadow: 0 3px 6px rgba(0,0,0,0.4);
  }
  50% {
    box-shadow: 0 3px 6px rgba(16, 185, 129, 0.6), 
                0 0 0 4px rgba(16, 185, 129, 0.2);
  }
}

.vehicle-marker-smooth > div {
  animation: vehiclePulse 2s ease-in-out infinite;
}

  .animate-fadeIn {
    animation: fadeIn 0.3s ease-out;
  }

  .animate-slideUp {
    animation: slideUp 0.4s ease-out;
  }
</style>